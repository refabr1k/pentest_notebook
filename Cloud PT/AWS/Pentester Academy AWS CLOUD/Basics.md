# IAM

trust policy - what entities can assume a role
trust policy - which entities can be which role
permission policy - what roles can access what resources
ARNs (Amazon resource names) - identify AWS resources
	- format:  
		- arn:partition:service:region:account-id:resource-id or /instance/*
		- (global service dont hav region) eg.  arn:aws:iam::908210938091:user
	- region
	- account id: 12

# Policies
	- JSON document
	- Contains permission statements
	- Policy Types
		- Identity-Based policies
		- Resource-based policies
		- Permissions boundaries
		- Organizations SCPs
		- Access Control lists (ACLs)
		- Session policies

## Policy Document Components
- Version - latest: 2012-10-17
- Statement - Main Policy element
- Sid (optional) - statement ID
- Effect - Use Allow or Deny 
- Principal - Account, User, Role or Federated user. 
	- Principal **cannot** be mentioned in IAM policy, the Policy is attached to the **principal**
	- Principal is mentioned in resource based policy
- Action - List of actions you can or cannot do
- Resource - The resource your actions is performed on, required in IAM permission policy. 
- Condition (Optional) - Criteria which policy grants permission


## Policies can be tuned 
- Permissions - to access 
- Policy usage - which groups that are using this policy
- Policy version - default will be used, up to 5 versions
- Access Advisor - Show policy that was last used
![](images/Pasted%20image%2020230209221109.png)

### Example policies

#### example of a misconfiguration:
![](images/Pasted%20image%2020230209223258.png)

The trust relationship `"AWS": "*"` is not suppose to happen. It should be as specific as possible to include eg. the specific ARN

#### Example: IAM policy vs Resource Policy
- IAM policies dont have Principal (the policy is attached to the principal)

![](images/Pasted%20image%2020230211090054.png)


#### Resource based policy
![](images/Pasted%20image%2020230211090529.png)


#### Deny policy Except roleId = "ARO....N"

![](images/Pasted%20image%2020230211090702.png)



## permission boundaries

### Explicit Deny
The example below shows that We can impose restrictions using 'permission boundaries'. Eg. user bob has role below hash administrator access to all
- Created a IAM role 'bob' and set a policy > admin access
![](images/Pasted%20image%2020230209224822.png)
- Set Trust relationship was setup that allow a specific user to assume AWS IAM role
- Attached a IAM policy bob to the user which restricts accesss to the below only
![](images/Pasted%20image%2020230209224739.png)
But because there is a 'LIMIT' or restriction such as below, the account will only have limited access 

## Identity Based Policies

![](images/Pasted%20image%2020230209225255.png)



## AWS Organization

#### Service Control Policy (SCP) 

**Scenario: You have (1) Administrative Access (2) FULL EC2 Permissions, but was unable to launch a new EC2 Instance?

![](images/Pasted%20image%2020230211092554.png)
![](images/Pasted%20image%2020230211092647.png)

#### So why cant you start a EC2 (micro) instance??

A policy that resides out of your 'view/control' which is managed by the 'Root'. This policy will control what you can or cannot do. In this example, you are a **Member Account**, and have administrative roles, full access to EC2. 


![](images/Pasted%20image%2020230211092329.png)

SCP is in place. Only allow you to start EC2 t2.small. 

![](images/Pasted%20image%2020230211091541.png)

During a pentest, we need to speculate if an SCP is in place if there are certain actions/operations that we cannot perform **even though** we are provided sufficient privileges 

---

# Policy Evaluation Logic




![](images/Pasted%20image%2020230223224305.png)


- S3 buckets: **Resource-based Policies** over **IAM Permissions boundaries**
	example when a Resource-based Policies "Allows", it takes precendence over the "IAM permissions boundaries" eventhough the permission boundaries may be set "not allow"